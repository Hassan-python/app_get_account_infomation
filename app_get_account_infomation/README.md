# レシート・クレジット履歴分析アプリ

## 概要

このアプリは、レシートやクレジットカード履歴の画像をアップロードするだけで、自動的に情報を抽出してExcelファイルにまとめることができる便利なツールです。

画像からテキストを読み取り、必要な情報（店名、日付、金額など）を自動的に識別します。さらに、データの編集や分類も簡単に行えます。

## 主な機能

### 📷 画像アップロードと処理
- レシートとクレジットカード履歴の画像を複数まとめてアップロード
- HEIC/HEIF形式を含む様々な画像形式に対応
- 画像の自動前処理（傾き補正、ノイズ除去、コントラスト強調など）

### 🔍 テキスト認識と情報抽出
- **OCR処理（Tesseract）**: 画像からテキストを高精度に抽出
  - 日本語と英語の両方に対応
  - 画像の前処理により認識精度を向上
  - 複数のOCRモードを自動試行して最適な結果を取得

- **情報抽出（DeepSeek API）**: OCRで抽出したテキストから必要な情報を識別
  - レシートから店名、日付、合計金額を自動抽出
  - クレジットカード履歴から複数の取引情報を一度に抽出
  - 日付形式の自動変換とバリデーション（未来の日付を検出）

### 📊 データ管理と編集
- 抽出データの手動編集（店名、金額、日付）
- 勘定科目の設定（食費、交通費、日用品など）
- 不要なエントリの削除
- Excelファイルへのエクスポート

### 🖼️ 使いやすいインターフェース
- タブ形式で機能を整理（レシート処理、クレジット履歴処理、データ確認・ダウンロード）
- 高品質な画像表示と情報表示
- 画像処理パラメータのカスタマイズ

## OCRとDeepSeek APIの連携処理

このアプリケーションの核となる技術は、OCR（Tesseract）とDeepSeek APIの連携です。この2段階のアプローチにより、高精度な情報抽出を実現しています。

### 処理の流れ

1. **画像の前処理**
   - 画像のノイズ除去、傾き補正、コントラスト強調などを行い、OCRの精度を向上

2. **OCR処理（Tesseract）**
   - 前処理された画像から生のテキストデータを抽出
   - 単なるテキスト認識のみで、どの部分が何の情報かは識別しない
   - 複数の認識モードを試行して最適な結果を得る

3. **DeepSeek API処理**
   - OCRで抽出した生テキストをDeepSeek APIに送信
   - AIモデルが文脈を理解し、テキストから意味のある情報を抽出
   - 例：「合計：1,980円」というテキストから「1980」という金額を抽出

4. **データの構造化と検証**
   - 抽出された情報を整理して構造化データに変換
   - 日付形式の統一や未来日付のチェックなどの検証を実施

### OCRとDeepSeek APIの役割分担

- **OCR（Tesseract）の役割**
  - 画像からテキストを認識する基本的な処理
  - 文字の形状を認識して文字列に変換
  - 日本語と英語の両方に対応（`-l jpn+eng`オプション使用）

- **DeepSeek APIの役割**
  - テキストの意味を理解し、必要な情報を抽出
  - 店名、日付、金額などの情報を識別
  - 複数の取引情報を一度に処理
  - 非構造化テキストから構造化データへの変換

この2段階のアプローチにより、単純なOCRだけでは難しい「どの部分が店名で、どの部分が金額か」といった意味的な情報抽出が可能になっています。OCRがテキストを認識し、DeepSeek APIがそのテキストを理解して構造化データに変換するという役割分担です。

## セットアップ方法

### 必要なもの
- Python 3.8以上
- Tesseract OCR 5.0以上
- DeepSeek API キー

### インストール手順

1. **リポジトリを取得**
   ```
   git clone <リポジトリURL>
   cd app_get_account_infomation
   ```

2. **必要なパッケージをインストール**
   ```
   pip install -r requirements.txt
   ```

3. **Tesseract OCRをインストール**
   - Windows: [Tesseract-OCRインストーラー](https://github.com/UB-Mannheim/tesseract/wiki)をダウンロードして実行
   - macOS: `brew install tesseract`
   - Linux: `sudo apt install tesseract-ocr`

4. **日本語OCRデータをインストール**
   - Windows: インストーラーで「Japanese」を選択
   - macOS/Linux: `sudo apt install tesseract-ocr-jpn`

5. **DeepSeek APIキーを設定**
   - `.env.example`ファイルを`.env`にコピー
   - `.env`ファイルを開き、`DEEPSEEK_API_KEY=あなたのAPIキー`を設定

## 使い方

### アプリの起動
```
streamlit run app.py
```
ブラウザで自動的に開かない場合は、http://localhost:8501 にアクセスしてください。

### レシート処理
1. 「レシート処理」タブを選択
2. 「レシート画像をアップロード」から画像を選択（複数可）
3. 必要に応じて画像処理オプションを調整
4. 「レシート情報を抽出」ボタンをクリック

### クレジット履歴処理
1. 「クレジット履歴処理」タブを選択
2. 「クレジット履歴画像をアップロード」から画像を選択（複数可）
3. 必要に応じて画像処理オプションを調整
4. 「クレジット履歴情報を抽出」ボタンをクリック

### データの確認と編集
1. 「データ確認・ダウンロード」タブを選択
2. 抽出されたデータを確認・編集
   - 店名、金額、日付を修正
   - 勘定科目を選択
   - 不要なエントリを削除
3. 「Excelファイルを作成」ボタンをクリック
4. 「Excelファイルをダウンロード」ボタンでファイルを保存

## 画像処理とテキスト抽出の詳細

### 画像処理の流れ
1. **画像の読み込みと形式変換**
   - 様々な形式（JPG, PNG, HEIC等）の画像を読み込み
   - 必要に応じてフォーマット変換（HEIC→PNG等）

2. **レシート領域の検出**
   - グレースケール変換
   - ガウシアンブラーでノイズ除去
   - Cannyエッジ検出でエッジを抽出
   - 膨張処理でエッジを強調
   - 輪郭検出と面積フィルタリング
   - 最大輪郭を検出してレシート領域を切り出し

3. **画像の前処理**
   - コントラスト強調（CLAHE）
   - 必要に応じて二値化処理

### OCR処理（Tesseract）
1. **テキスト抽出の実行**
   - 前処理済み画像に対してOCR実行
   - 日本語と英語の両方に対応（`-l jpn+eng`）
   - 複数のページセグメンテーションモード（PSM）を試行
     - PSM 3: 自動ページセグメンテーション
     - PSM 6: 単一のテキストブロックとして処理

2. **OCR結果の改善**
   - テキストが検出されない場合、別のPSMで再試行
   - それでも検出されない場合、画像の二値化処理を実施

### 情報抽出（DeepSeek API）
1. **レシート情報の抽出**
   - OCRで抽出したテキストをDeepSeek APIに送信
   - プロンプトで店名、日付、合計金額の抽出を指示
   - 日付はYYYY-MM-DD形式に統一
   - 合計金額は数値のみを抽出

2. **クレジット履歴の抽出**
   - OCRテキストから複数取引の情報を抽出
   - 各取引の店名、日付、金額をJSON形式で取得
   - 複数の取引をリストとして整理

3. **日付の検証**
   - 抽出された日付が未来の日付でないかチェック
   - 未来の日付が検出された場合、ユーザーに修正を促す

## 画像処理パラメータのカスタマイズ

### 基本設定
- **前処理後の画像を表示**: 処理過程の画像を確認できます
- **検出されたレシートを表示**: 切り出されたレシート領域を確認できます
- **コントラスト強調**: 文字の視認性を向上させます

### 詳細設定
- **エッジ検出の閾値**: エッジの検出感度を調整（低いほど多くのエッジを検出）
- **最小輪郭面積**: 検出する輪郭の最小サイズ（小さいノイズを除外）
- **膨張処理の反復回数**: エッジの強調度合いを調整

## トラブルシューティング

### OCR関連の問題
- **テキストが正しく認識されない**: 
  - 画像処理パラメータを調整してみてください
  - コントラスト強調をオンにすると認識率が向上することがあります
  - 詳細設定でエッジ検出パラメータを調整してみてください

- **「tesseract is not installed」エラー**:
  - Tesseractが正しくインストールされているか確認
  - Windowsの場合、環境変数PATHにTesseractのパスが追加されているか確認

### API関連の問題
- **「DeepSeek APIキーが設定されていません」エラー**:
  - `.env`ファイルにAPIキーが正しく設定されているか確認
  - APIキーの有効期限が切れていないか確認

### その他の問題
- **Excelファイル作成エラー**: `pip install openpyxl`でパッケージをインストール
- **HEIC/HEIF画像が開けない**: `pip install pillow-heif`でサポートを追加
- **メモリエラー**: 大きな画像や多数の画像を処理する場合はメモリ不足になることがあります。一度に処理する画像数を減らしてみてください。 