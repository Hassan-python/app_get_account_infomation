# 押印抽出アプリ（Stamp Extractor App）

## 概要
このアプリケーションは、画像から押印（ハンコやスタンプ）部分を自動的に検出・抽出するためのツールです。機械学習（K-meansクラスタリング）と画像処理技術を活用して、文書や画像内の押印を識別し、個別に保存することができます。ビジネス文書や契約書などから押印を効率的に抽出し、管理することを目的としています。

## 特徴
- 画像から押印部分を自動検出
- 検出された押印の位置を視覚的に表示
- 個々の押印を個別に抽出・ダウンロード可能
- パラメータ調整による検出精度の最適化
- 直感的なユーザーインターフェースによる簡単な操作
- リアルタイムでの処理結果表示

## 技術的詳細
このアプリは以下の技術を使用しています：
- **Streamlit**: Webインターフェースの構築
  - インタラクティブなUIコンポーネント（スライダー、ファイルアップローダー、ダウンロードボタン）
  - レイアウト制御（カラム、サイドバー）
  - 処理状態の表示（スピナー、成功/警告メッセージ）
- **OpenCV (cv2)**: 画像処理
  - グレースケール変換
  - ガウシアンブラーによるノイズ除去
  - 連結成分分析（connectedComponentsWithStats）
  - 矩形描画による検出結果の可視化
- **scikit-learn**: K-meansクラスタリング
  - 画素値に基づく2クラスタへの分類
  - 教師なし学習による自動分類
- **NumPy**: 数値計算と配列操作
  - 効率的な画像データの処理
  - マスク生成と操作
- **PIL (Pillow)**: 画像の保存と変換
  - 抽出された押印の保存
  - 画像フォーマット変換

## 押印検出の原理
このアプリは以下の原理に基づいて押印を検出します：

1. **ノイズ除去と特徴強調**:
   - ガウシアンブラーによるノイズ除去は、画像内の細かい変動（小さなノイズ）を滑らかにします
   - これにより、本当に重要な特徴（押印など）と単なるノイズを区別しやすくなります
   - ノイズ除去は「シグナル（押印）」と「ノイズ（紙の質感や小さな斑点など）」を分離する前処理として機能します

2. **画素の集中と押印の関係**:
   - 押印は通常、背景と異なる濃さ（多くの場合は濃い色）を持つ領域です
   - ノイズ除去後、K-meansクラスタリングによって画素値が似ている領域がグループ化されます
   - 押印部分は似たような画素値（例：暗い値）が集中している領域として検出されます

3. **判断プロセスの詳細**:
   - アルゴリズムは「画素値が似ていて、まとまっている領域」を見つけます
   - 特に少数派のクラスタ（通常は押印に相当）に注目します
   - その後、連結成分分析によって「一定以上のサイズで連続している領域」を押印と判断します

つまり、このアプリは「ノイズを除去した後、似た色の画素がある程度の大きさでまとまっている領域」を押印として検出しています。K-meansクラスタリングによって背景と押印候補を分離し、その中から適切なサイズの領域を抽出するという流れです。

このアプローチの利点は、押印の色や形状に関する事前知識がなくても、画像内の「他と異なる特徴を持つまとまった領域」を自動的に見つけられることです。

## アルゴリズムの詳細
### K-meansクラスタリングによる押印検出
1. 画像をグレースケールに変換し、ガウシアンブラーでノイズを除去
2. 画素値を1次元配列に変換し、K-means（k=2）でクラスタリング
3. 各クラスタの画素数をカウントし、少数派のクラスタを押印候補として抽出
   - 押印は通常、背景よりも面積が小さいという前提に基づく
4. 2値マスクを生成し、連結成分分析で個々の押印領域を特定
5. 最小面積以上の連結成分を押印として抽出

## 処理フロー
1. 画像のグレースケール変換とノイズ除去
2. K-meansクラスタリングによる画像の2値化（押印部分と背景の分離）
3. 連結成分分析による押印領域の特定
4. 検出された押印の抽出と表示

## 使い方
### サイドバーのパラメータ設定
サイドバーには以下の調整可能なパラメータがあります：

1. **最小面積（Min Area）**
   - スライダー範囲: 10〜5000ピクセル（デフォルト: 100）
   - 機能: 検出する押印の最小サイズを指定
   - 技術的背景: 連結成分分析で検出された領域のうち、この値より小さい領域は無視されます
   - 調整のコツ:
     - 小さすぎる値: ノイズや小さな斑点も検出してしまう
     - 大きすぎる値: 小さな押印が検出されなくなる
     - 文書の解像度に応じて調整が必要

2. **ぼかしサイズ（Blur Size）**
   - スライダー範囲: 1〜15ピクセル（デフォルト: 5）
   - 機能: ガウシアンブラーのカーネルサイズを指定
   - 技術的背景: 
     - 常に奇数値が使用される（偶数が選択された場合は+1される）
     - 値が大きいほど強いぼかし効果
   - 調整のコツ:
     - 小さい値: 細かいディテールが保持されるが、ノイズも残る
     - 大きい値: ノイズが減少するが、押印の輪郭がぼやける
     - スキャン品質の低い画像では大きめの値が効果的

### 操作手順
1. サイドバーでパラメータを調整
   - **最小面積**: 検出する押印の最小サイズ（小さすぎると誤検出が増加）
   - **ぼかしサイズ**: ノイズ除去のための画像ぼかし強度

2. 押印がある画像をアップロード（対応形式: JPG, JPEG, PNG）
   - ドラッグ＆ドロップまたはファイル選択ダイアログから選択
   - 高解像度の画像ほど検出精度が向上

3. 検出結果の確認
   - **元の画像**: アップロードされた元画像
   - **抽出マスク**: K-meansクラスタリングによって生成された2値マスク画像
     - 白い部分が押印候補領域
   - **検出結果**: 元画像に緑色の矩形で押印位置を表示
   - **抽出された押印**: 個別に切り出された押印画像（最大5列で表示）

4. 必要に応じて個々の押印をダウンロード
   - 各押印画像の下にあるダウンロードボタンをクリック
   - PNG形式で保存されます

## インストール方法
```bash
# 必要なライブラリのインストール
pip install streamlit opencv-python numpy scikit-learn matplotlib pillow

# アプリの実行
streamlit run stamp_extractor_app.py
```

## 動作環境
- Python 3.6以上
- 十分なメモリ（大きな画像を処理する場合）
- ウェブブラウザ（Chrome, Firefox, Edgeなど最新版推奨）

## 注意事項
- 画像の品質や押印の鮮明さによって検出精度が変わります
- 背景と押印のコントラストが高いほど良好な結果が得られます
- パラメータ調整が検出結果に大きく影響します
- 非常に複雑な背景を持つ画像では誤検出が増える可能性があります
- 大きな画像の処理には時間がかかる場合があります

## 技術的な制限事項
- 現在の実装では色情報を使用していないため、色の違いによる押印の識別はできません
- K-meansクラスタリングは2クラスタのみを使用しているため、複雑な背景では精度が低下します
- 文字と押印の区別が難しい場合があります（特に太字や黒い文字）

## 開発者向け情報
### アルゴリズムの改善点
- 色情報を活用した検出精度の向上
  - HSVカラースペースでの分析
  - 押印に特徴的な色（赤など）の検出
- 機械学習モデルのトレーニングによる押印特有のパターン認識
  - CNNなどのディープラーニングモデルの導入
  - 押印データセットによる学習
- 文字と押印の区別を改善するためのテキスト検出の統合
  - OCRとの組み合わせ
  - テキスト領域の除外処理

### コード構造
- `extract_stamps()`: 押印抽出の中核アルゴリズム
- `main()`: Streamlitインターフェースとアプリケーションフロー

### 将来の拡張可能性
- バッチ処理による複数画像の一括処理
- 押印の分類機能（丸印、角印、署名など）
- 検出された押印のデータベース管理
- PDFファイルからの直接抽出 