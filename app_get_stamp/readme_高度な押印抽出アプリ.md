# 高度な押印抽出アプリ（Advanced Stamp Extractor App）

## 概要
このアプリケーションは、画像から押印（ハンコやスタンプ）部分を自動的に検出・抽出するための高度なツールです。複数の画像処理アルゴリズム（K-meansクラスタリング、色空間フィルタリング、エッジ検出）を選択できるため、様々な種類の文書や画像から効率的に押印を抽出することができます。ビジネス文書や契約書などの押印管理に最適です。

## 特徴
- 複数の抽出方法から選択可能（K-meansクラスタリング、色空間フィルタリング、エッジ検出）
- 赤印・青印・黒印など、色に基づいた押印の選択的抽出
- 検出された押印の位置を視覚的に表示
- 個々の押印を個別に抽出・ダウンロード可能
- 詳細なパラメータ調整による検出精度の最適化
- 直感的なユーザーインターフェースによる簡単な操作
- リアルタイムでの処理結果表示

## 技術的詳細
このアプリは以下の技術を使用しています：
- **Streamlit**: Webインターフェースの構築
  - インタラクティブなUIコンポーネント（セレクトボックス、スライダー、ファイルアップローダー）
  - レイアウト制御（カラム、サイドバー）
  - 処理状態の表示（スピナー、成功/警告メッセージ）
- **OpenCV (cv2)**: 高度な画像処理
  - グレースケール・HSV色空間変換
  - ガウシアンブラーによるノイズ除去
  - Cannyエッジ検出
  - モルフォロジー演算
  - 連結成分分析（connectedComponentsWithStats）
  - 矩形描画による検出結果の可視化
- **scikit-learn**: K-meansクラスタリング
  - 画素値に基づく2クラスタへの分類
  - 教師なし学習による自動分類
- **NumPy**: 数値計算と配列操作
  - 効率的な画像データの処理
  - マスク生成と操作
- **PIL (Pillow)**: 画像の保存と変換
  - 抽出された押印の保存
  - 画像フォーマット変換

## 押印検出の方法
このアプリは3つの異なる方法で押印を検出します：

### 1. K-meansクラスタリングによる検出
- **原理**: 画像の画素値を2つのクラスタに分類し、少数派のクラスタを押印候補として抽出
- **特徴**: 色や形状に関する事前知識がなくても自動的に押印を検出
- **適した用途**: 背景と押印のコントラストが明確な文書
- **処理フロー**:
  1. 画像をグレースケールに変換し、ガウシアンブラーでノイズを除去
  2. 画素値を1次元配列に変換し、K-means（k=2）でクラスタリング
  3. 各クラスタの画素数をカウントし、少数派のクラスタを押印候補として抽出
  4. 2値マスクを生成し、連結成分分析で個々の押印領域を特定
  5. 最小面積以上の連結成分を押印として抽出

### 2. 色空間フィルタリングによる検出
- **原理**: HSV色空間で特定の色範囲（赤、青、黒など）をフィルタリングして押印を抽出
- **特徴**: 特定の色の押印を選択的に抽出可能
- **適した用途**: 赤印や青印など、色が明確な押印の抽出
- **処理フロー**:
  1. 画像をHSV色空間に変換
  2. 選択された色範囲（赤、青、黒）に基づいてマスクを生成
  3. ガウシアンブラーとしきい値処理でノイズを除去
  4. 連結成分分析で個々の押印領域を特定
  5. 最小面積以上の連結成分を押印として抽出

### 3. エッジ検出による検出
- **原理**: Cannyエッジ検出と形態学的処理を組み合わせて押印の輪郭を検出
- **特徴**: 押印の境界線に基づいた検出が可能
- **適した用途**: 背景と押印の色差が小さいが、輪郭がはっきりしている場合
- **処理フロー**:
  1. 画像をグレースケールに変換し、ガウシアンブラーでノイズを除去
  2. Cannyアルゴリズムでエッジを検出
  3. モルフォロジー演算（クロージング）で輪郭を閉じる
  4. 連結成分分析で個々の押印領域を特定
  5. 最小面積以上の連結成分を押印として抽出

## 使い方
### サイドバーのパラメータ設定
サイドバーには以下の調整可能なパラメータがあります：

1. **抽出方法**
   - **K-meansクラスタリング**: 画像を背景と前景に分離
   - **色空間フィルタリング**: 特定の色の押印を抽出
   - **エッジ検出**: 画像のエッジを検出し、閉じた輪郭を押印として抽出

2. **共通パラメータ**
   - **最小面積（Min Area）**: 10〜5000ピクセル（デフォルト: 100）
     - 検出する押印の最小サイズを指定
     - 小さすぎる値: ノイズも検出される
     - 大きすぎる値: 小さな押印が検出されなくなる
   - **ぼかしサイズ（Blur Size）**: 1〜15ピクセル（デフォルト: 5）
     - ガウシアンブラーのカーネルサイズを指定
     - 小さい値: 細かいディテールが保持されるが、ノイズも残る
     - 大きい値: ノイズが減少するが、押印の輪郭がぼやける

3. **色空間フィルタリング用パラメータ**
   - **抽出する色**: 赤、青、黒から選択
     - 赤: 一般的な朱肉の押印
     - 青: 青インクの押印
     - 黒: 黒インクの押印や署名

4. **エッジ検出用パラメータ**
   - **Canny低閾値**: 10〜200（デフォルト: 50）
     - エッジ検出の感度を調整
     - 低い値: より多くのエッジを検出（ノイズも増加）
   - **Canny高閾値**: 50〜300（デフォルト: 150）
     - 強いエッジの基準を調整
     - 高い値: 明確なエッジのみ検出

### 操作手順
1. サイドバーで抽出方法とパラメータを選択
   - 文書の種類や押印の特徴に合わせて最適な方法を選択

2. 押印がある画像をアップロード（対応形式: JPG, JPEG, PNG）
   - ドラッグ＆ドロップまたはファイル選択ダイアログから選択
   - 高解像度の画像ほど検出精度が向上

3. 検出結果の確認
   - **元の画像**: アップロードされた元画像
   - **抽出マスク**: 選択した方法で生成された2値マスク画像
   - **検出結果**: 元画像に緑色の矩形で押印位置を表示
   - **抽出された押印**: 個別に切り出された押印画像（最大5列で表示）

4. 必要に応じて個々の押印をダウンロード
   - 各押印画像の下にあるダウンロードボタンをクリック
   - PNG形式で保存されます

## インストール方法
```bash
# 必要なライブラリのインストール
pip install streamlit opencv-python numpy scikit-learn matplotlib pillow

# アプリの実行
streamlit run advanced_stamp_extractor_app.py
```

## 動作環境
- Python 3.6以上
- 十分なメモリ（大きな画像を処理する場合）
- ウェブブラウザ（Chrome, Firefox, Edgeなど最新版推奨）

## 各抽出方法の比較
| 抽出方法 | 長所 | 短所 | 最適な用途 |
|---------|------|------|-----------|
| K-meansクラスタリング | 事前知識不要で自動的に検出<br>様々な色の押印に対応 | 背景が複雑な場合は精度低下<br>文字と押印の区別が難しい | 一般的な文書<br>コントラストが明確な押印 |
| 色空間フィルタリング | 特定の色の押印を正確に抽出<br>背景の影響を受けにくい | 指定した色以外の押印は検出不可<br>色あせた押印は検出しにくい | 赤印や青印など<br>色が明確な押印 |
| エッジ検出 | 輪郭がはっきりした押印に強い<br>色に依存しない | パラメータ調整が難しい<br>背景にノイズが多いと誤検出 | 印影が鮮明な押印<br>背景と色差が小さい押印 |

## 注意事項
- 画像の品質や押印の鮮明さによって検出精度が変わります
- 背景と押印のコントラストが高いほど良好な結果が得られます
- パラメータ調整が検出結果に大きく影響します
- 非常に複雑な背景を持つ画像では誤検出が増える可能性があります
- 大きな画像の処理には時間がかかる場合があります

## 技術的な制限事項
- 色空間フィルタリングは事前定義された色範囲に依存するため、色あせた押印や中間色の押印は検出しにくい
- エッジ検出は背景のノイズや文字のエッジも検出するため、文書が複雑な場合は誤検出が増える
- 複数の方法を組み合わせた統合アルゴリズムは実装されていないため、最適な方法を手動で選択する必要がある

## 開発者向け情報
### コード構造
- `extract_stamps_kmeans()`: K-meansクラスタリングによる押印抽出
- `extract_stamps_color()`: 色空間フィルタリングによる押印抽出
- `extract_stamps_edge()`: エッジ検出による押印抽出
- `process_mask()`: マスク処理と連結成分分析の共通処理
- `main()`: Streamlitインターフェースとアプリケーションフロー

### 将来の拡張可能性
- 機械学習モデル（CNN等）による押印検出の追加
- 複数の抽出方法を組み合わせたアンサンブル手法の実装
- 押印の種類（丸印、角印、署名など）の自動分類
- バッチ処理による複数画像の一括処理
- PDFファイルからの直接抽出
- 検出された押印のデータベース管理システムとの連携 